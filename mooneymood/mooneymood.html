<!DOCTYPE html>
<html>

<head>
  <title>My experiment</title>
  <script src="jsPsych-6.0.3/jspsych.js"></script>
  <script src="jsPsych-6.0.3/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jsPsych-6.0.3/plugins/jspsych-html-slider-response.js"></script>
  <script src="jsPsych-6.0.3/plugins/jspsych-image-keyboard-response.js"></script>
  <script src="jsPsych-6.0.3/plugins/jspsych-html-button-response.js"></script>
  <script src="jsPsych-6.0.3/plugins/jspsych-survey-text.js"></script>
  <script src="jsPsych-6.0.3/plugins/jspsych-survey-likert.js"></script>
  <script src="jsPsych-6.0.3/plugins/jspsych-fullscreen.js"></script>
  <script src="jsPsych-6.0.3/plugins/jspsych-animate-transparency.js"></script>
  <script src="jsPsych-6.0.3/plugins/jspsych-same-different-image.js"></script>
  <script src="stimset.json" type="text/javascript" charset="utf-8"></script>
  <link href="jsPsych-6.0.3/css/jspsych.css" rel="stylesheet" type="text/css">
  </link>
</head>

<body>
  <noscript>
    <h1>Warning: Javascript seems to be disabled</h1>
    <p>This website requires that Javascript be enabled on your browser.</p>
    <p>Instructions for enabling Javascript in your browser can be found
      <a href="http://support.google.com/bin/answer.py?hl=en&answer=23852">here</a>
      <p>
  </noscript>
</body>
<script>
  // returns param value from url if name/key given
  function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
      results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }

  function loadJSON(filename, callback) {

    var xobj = new XMLHttpRequest();
    xobj.overrideMimeType("application/json");
    xobj.open('GET', filename, true);
    xobj.onreadystatechange = function () {
      if (xobj.readyState == 4 && xobj.status == "200") {
        // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
        callback(xobj.responseText);
      }
    };
    xobj.send(null);
  }


  function saveData(name, data) {

    var xhr = new XMLHttpRequest();
    // Met deze code kan je de respons van de server bekijken in het console venster
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        console.log(xhr.response);
      }
    }
    xhr.open('POST', 'https://www.psytests.be/tests/curimoon/curimoon.php');
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.send("filename=" + name + "&prolific_id=" + JSON.stringify(subject_id) + "&filedata=" + JSON.stringify(data));
  }

  /**
   * Randomize array element order in-place.
   * Using Durstenfeld shuffle algorithm.
   */
  function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }
  }


  var experiment_name = 'mooneymood'
  var subject_id = getParameterByName('PROLIFIC_PID');
  // how many stimuli per session?
  var nb_stim_per_session = 30;
  var condition = 0; //if 0: upright mooneys 
  var stimlist = [];
  var finishurl= "";

  var images = ["img/018tt.jpg", "img/018gs.jpg"] // the list of images to preload

  loadJSON('stimset.json', function (response) {
    createstimlists(response);
    runExp();
  });

  function createstimlists(response) {

    stimlist = JSON.parse(response);
    // pick a random subset of images for the subject at the start of the experiment
    //stimlist = STIMS
    stimlist = jsPsych.randomization.sampleWithoutReplacement(stimlist, nb_stim_per_session);

    // set old/new variable for determining phase 
    for (i = 0; i < stimlist.length; i++) {
      images.push(stimlist[i]['mooney'])
      images.push(stimlist[i]['solution'])

    }

  }


  function runExp() {

    // randomly assign half of subjects to condition with inverted mooneys (ori 180)
    number = subject_id.match(/\d+/g).map(Number)[0];
    if (number % 2 == 0) {
      condition = 180
    }

    // questionnaire panas items
    qitems = ["Interested", "Distressed", "Excited", "Upset", "Strong", "Guilty", "Scared", "Hostile", "Enthusiastic",
      "Proud", "Irritable", "Alert", "Ashamed", "Inspired", "Nervous", "Determined", "Attentive", "Jittery", "Active",
      "Afraid"
    ];

    //randomize item order
    shuffleArray(qitems);

    //format as required for survey-likert plugin
    formattedqitems = []
    for (let i = 0; i < qitems.length; i++) {
      formattedqitems.push({
        prompt: qitems[i],
        labels: ["Very slightly or not at all", "A little", "Moderately", "Quite a bit", "Extremely"],
        required: true
      })
    }

    // record extra info in the jsPsych data
    // this adds a property called 'subject' to every trial
    jsPsych.data.addProperties({
      subject: subject_id,
      condition: condition,
      panasOrder: qitems,
      experiment_name: experiment_name
    });

    /* create timeline */
    var timeline = [];

    /* define welcome message trial */
    var welcome = {
      type: "html-keyboard-response",
      stimulus: "Welcome to the experiment. Press any key to begin.",
      data: {
        test_part: 'instructions'
      }
    };
    timeline.push(welcome);

    var consent = {
      type: "html-button-response",
      choices: ["I agree"],
      stimulus: "<div style='word-wrap: break-word; width: 900px'><h3>Please consider this information carefully before deciding whether to participate in this research</h3>" +
        "<ul style='text-align: left; font-size: .8em;'>" +
        "<li><b>Time required</b>: Participation will take between 15 and 45 minutes to complete.</li>" +
        "<li><b>Risks</b>:  There are no anticipated risks associated with participating in this study. The effects of participating should be comparable to those you would experience from viewing a computer monitor for 30 minutes and using a mouse or keyboard.</li>" +
        "<li><b>Benefits</b>:  This study provides no benefits to you individually except for the monetary reward. The study provides important information about the nature of perception and learning.</li>" +
        "<li><b>Confidentiality</b>:  Your participation in this study will remain confidential. No personally identifiable information will be associated with your data. Your de-identified data may be shared with other researchers and used in future projects.</li>" +
        "<li><b>Participation and withdrawal</b>:  Your participation in this study is completely voluntary and you may refuse to participate or you may choose to withdraw at any time without penalty.</li>" +
        "<li><b>How to contact the researchers</b>: If you have questions or concerns about your participation or payment, or want to request a summary of research findings, please contact Sander Van de Cruys (KU Leuven), at sander.vandecruys@kuleuven.be.</li></ul>" +
        "<p>The nature and purpose of this research have been sufficiently explained and I agree to participate in this study.  I understand that I am free to withdraw at any time without incurring any penalty.</p>" +
        "<p>Please consent by clicking the button below to continue. Otherwise, please exit the study at this time.</p></div>",
      data: {
        test_part: 'instructions'
      }
    };
    timeline.push(consent);

    /* define instructions trial */
    var instructions1 = {
      type: "html-button-response",
      stimulus: "<div style='word-wrap: break-word; width: 900px'><h3>Instructions: read carefully!</h3>" +
        "<p>This is a memory experiment that consists of 3 short parts. In the first part you'll have to fill in a brief emotion-questionnaire. " +
        "In the second part you'll see a series of black and white images, that you'll have to try to remember in the last part.</p>" +
        "<p>Please complete each task immediately after the other. The experiment will only take about 10 minutes in total.</p>" +
        "<p>Press enter to start the first part of the experiment.</p></div>",
      post_trial_gap: 0,
      choices: ['Start'],
      data: {
        test_part: 'instructions'
      }
    };
    timeline.push(instructions1);

    /* phase 1 */


  var panas_questionnaire = {
    type: 'survey-likert',
    preamble: "<div style='word-wrap: break-word; width: 900px'><h3>Part 1: Questionnaire</h3><p>This scale consists of a number of words that describe different feelings and emotions. Read each item and indicate the extent you have felt this way <strong>over the past week</strong></p></div>",
    questions: formattedqitems,
    data: {
      test_part: 'panas_questionnaire'
    }
  };

  timeline.push(panas_questionnaire);

  /* phase 2 */

  /* define instructions trial */
  var instructions2 = {
      type: "html-keyboard-response",
      stimulus: "<div style='word-wrap: break-word; width: 900px'><h3>Start part 2</h3>" +
        "<p>You will see a serious of black and white images. Please pay close attention to the objects in the images because you'll need to remember them afterwards. You do not need to respond to the images, just passively look at them.</p>" +
        "<p>Press any key to start the second part of the experiment.</p></div>",
      post_trial_gap: 0,
      data: {
        test_part: 'instructions'
      }
    };
    timeline.push(instructions2);

  var fixation = {
    type: 'html-keyboard-response',
    stimulus: '<div style="font-size:60px;">+</div>',
    choices: jsPsych.NO_KEYS,
    trial_duration: 200,
    data: {
      test_part: 'fixation'
    }
  }

  var reveal = {
    type: 'animate-transparency',
    stimuli: function () {
      return [jsPsych.timelineVariable('mooney')(), jsPsych.timelineVariable('solution')()];
    },
    choices: jsPsych.NO_KEYS,
    trial_duration: 4000,
    orientation: condition,
    data: {
      test_part: 'reveal',
    }
  };

  var mooney = {
    type: 'image-keyboard-response',
    stimulus: jsPsych.timelineVariable('mooney'),
    choices: jsPsych.NO_KEYS,
    trial_duration: 500,
    orientation: condition,
    data: {
      test_part: 'mooney',
    }
  };


  var phase2_procedure = {
    timeline: [fixation, reveal, mooney],
    timeline_variables: stimlist,
    repetitions: 1,
    randomize_order: true
  };

  timeline.push(phase2_procedure);

  /* phase 3 below */


  var posttest = {
    type: 'survey-text',
    questions: [{
      prompt: "<div style='word-wrap: break-word; width: 900px'><h3>Part 3: Memory</h3><p>Contrary to what we said earlier, we now want you to try to <strong>remember as many words as possible from the emotion questionnaire</strong> you completed in the beginning of the experiment. So we are <strong>not</strong> interested in whether you remember the images you just saw, only in the emotion words you can still remember from the first part. Please list them below, separated by comma's</p></div>",
      rows: 5,
      columns: 50
    }],
    data: {
      test_part: 'posttest'
    }
  };

   timeline.push(posttest);

  /* define debrief */

  var debrief = {
    type: "html-keyboard-response",
    stimulus: "<div style='word-wrap: break-word; width: 900px'><h1>Thank you!</h1><p>You completed the experiment. As you noticed we were interested in incidental (non-intentional) learning (not in your memory for images), and in how it is affected by in-between intentional learning of different materials. Apologies for misleading you.</p>" +
      "<p>Press any key to return to...</p></div>",
    data: {
      test_part: 'instructions'
    }
  };
  timeline.push(debrief);

  /* start the experiment */
  jsPsych.init({
    timeline: timeline,
    show_progress_bar: true,
    preload_images: images,
    exclusions: {
      min_width: 800,
      min_height: 600
    },
    on_finish: function () {
      jsPsych.data.addProperties({
        totalTime: jsPsych.totalTime()
      });
      saveData("curimoon.csv", jsPsych.data.get().csv());
      window.location=finishurl
    }
  });
  }
</script>

</html>