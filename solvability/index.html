<!DOCTYPE html>
<html>

<head>
  <title>My experiment</title>
  <script src="jsPsych/jspsych.js"></script>
  <script src="jsPsych/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jsPsych/plugins/jspsych-html-slider-response.js"></script>
  <script src="jsPsych/plugins/jspsych-image-keyboard-response.js"></script>
  <script src="jsPsych/plugins/jspsych-html-button-response.js"></script>
  <script src="jsPsych/plugins/jspsych-survey-text.js"></script>
  <script src="jsPsych/plugins/jspsych-survey-html-form.js"></script>
  <script src="jsPsych/plugins/jspsych-survey-likert.js"></script>
  <script src="jsPsych/plugins/jspsych-fullscreen.js"></script>
  <script src="stimset.json" type="text/javascript" charset="utf-8"></script>
  <link href="jsPsych/css/jspsych.css" rel="stylesheet" type="text/css">
  </link>
</head>

<body>
  <noscript>
    <h1>Warning: Javascript seems to be disabled</h1>
    <p>This website requires that Javascript be enabled on your browser.</p>
    <p>Instructions for enabling Javascript in your browser can be found
      <a href="http://support.google.com/bin/answer.py?hl=en&answer=23852">here</a>
      <p>
  </noscript>
</body>
<script>
  var experiment_name = 'solvability'
  var subject_id = getParameterByName('PROLIFIC_PID');
  // how many stimuli per participant?
  var nb_stim_per_session = 60; // aim for 100?
  var stimlist = [];
  var completionurl = "bye.html";
  var images = ["../img/018tt.jpg", "../img/018gs.jpg", "aha.jpg"] // the list of images to preload


  practicelist = [{
    "mooney": "../img/tt/1286tt.jpg",
    "solution": "../img/gs/1286gs.jpg",
    "pict": "../solvability/picts/pict68.png",
    "condition": "practice"
  }, {
    "mooney": "../img/tt/1308tt.jpg",
    "solution": "../img/gs/1308gs.jpg",
    "pict": "../solvability/picts/pict69.png",
    "condition": "practice"
  }, {
    "mooney": "../img/tt/407tt.jpg",
    "solution": "../img/gs/407gs.jpg",
    "pict": "../solvability/picts/pict70.png",
    "condition": "practice"
  }, {
    "mooney": "../img/tt/419tt.jpg",
    "solution": "../img/gs/419gs.jpg",
    "pict": "../solvability/picts/pict71.png",
    "condition": "practice"
  }]

  var picts = ['../solvability/picts/pict27.png',
    '../solvability/picts/pict11.png',
    '../solvability/picts/pict24.png',
    '../solvability/picts/pict36.png',
    '../solvability/picts/pict30.png',
    '../solvability/picts/pict58.png',
    '../solvability/picts/pict28.png',
    '../solvability/picts/pict35.png',
    '../solvability/picts/pict1.png',
    '../solvability/picts/pict51.png',
    '../solvability/picts/pict10.png',
    '../solvability/picts/pict4.png',
    '../solvability/picts/pict19.png',
    '../solvability/picts/pict38.png',
    '../solvability/picts/pict32.png',
    '../solvability/picts/pict33.png',
    '../solvability/picts/pict56.png',
    '../solvability/picts/pict9.png',
    '../solvability/picts/pict37.png',
    '../solvability/picts/pict0.png',
    '../solvability/picts/pict55.png',
    '../solvability/picts/pict6.png',
    '../solvability/picts/pict57.png',
    '../solvability/picts/pict2.png',
    '../solvability/picts/pict17.png',
    '../solvability/picts/pict18.png',
    '../solvability/picts/pict47.png',
    '../solvability/picts/pict39.png',
    '../solvability/picts/pict15.png',
    '../solvability/picts/pict21.png',
    '../solvability/picts/pict48.png',
    '../solvability/picts/pict12.png',
    '../solvability/picts/pict50.png',
    '../solvability/picts/pict13.png',
    '../solvability/picts/pict44.png',
    '../solvability/picts/pict31.png',
    '../solvability/picts/pict26.png',
    '../solvability/picts/pict42.png',
    '../solvability/picts/pict7.png',
    '../solvability/picts/pict61.png',
    '../solvability/picts/pict40.png',
    '../solvability/picts/pict43.png',
    '../solvability/picts/pict46.png',
    '../solvability/picts/pict3.png',
    '../solvability/picts/pict52.png',
    '../solvability/picts/pict49.png',
    '../solvability/picts/pict23.png',
    '../solvability/picts/pict34.png',
    '../solvability/picts/pict62.png',
    '../solvability/picts/pict59.png',
    '../solvability/picts/pict20.png',
    '../solvability/picts/pict60.png',
    '../solvability/picts/pict16.png',
    '../solvability/picts/pict29.png',
    '../solvability/picts/pict53.png',
    '../solvability/picts/pict25.png',
    '../solvability/picts/pict5.png',
    '../solvability/picts/pict14.png',
    '../solvability/picts/pict8.png',
    '../solvability/picts/pict41.png'
  ];


  // preload practice images 
  for (i = 0; i < practicelist.length; i++) {

    images.push(practicelist[i]['mooney'])
    images.push(practicelist[i]['solution'])
    images.push(practicelist[i]['pict'])


  }


  // returns param value from url if name/key given
  function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
      results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }

  function loadJSON(filename, callback) {

    var xobj = new XMLHttpRequest();
    xobj.overrideMimeType("application/json");
    xobj.open('GET', filename, true);
    xobj.onreadystatechange = function () {
      if (xobj.readyState == 4 && xobj.status == "200") {
        // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
        callback(xobj.responseText);
      }
    };
    xobj.send(null);
  }


  function saveData(name, data) {
    //console.log(data)
    var xhr = new XMLHttpRequest();
    // Met deze code kan je de respons van de server bekijken in het console venster
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        console.log(xhr.response);
        window.location = completionurl
      }
    }
    xhr.open('POST', 'https://www.psytests.be/tests/curimoon/curimoon.php');
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.send("filename=" + name + "&prolific_id=" + JSON.stringify(subject_id) + "&filedata=" + JSON.stringify(data));
  }

  /**
   * Randomize array element order in-place.
   * Using Durstenfeld shuffle algorithm.
   */
  function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }
  }



  loadJSON('stimset.json', function (response) {
    createstimlists(response);
    runExp();
  });

  function createstimlists(response) {

    stimlist = JSON.parse(response);
    shuffleArray(picts);

    if (stimlist.length != picts.length) {
      console.log('lists do not match');
    }

    // set old/new variable for determining phase 
    for (i = 0; i < stimlist.length; i++) {

      images.push(stimlist[i]['mooney'])
      images.push(stimlist[i]['solution'])
      stimlist[i]['pict'] = picts[i]
      images.push(stimlist[i]['pict'])

    }

  }


  function runExp() {

    // record extra info in the jsPsych data
    // this adds a property called 'subject' to every trial


    /* create timeline */
    var timeline = [];

    /* define welcome message trial */
    var welcome = {
      type: "html-keyboard-response",
      stimulus: "Welcome to the experiment. This is an online experiment so please don't close the tab/window until we say goodbye.  Press any key to begin.",
      data: {
        test_part: 'instructions'
      }
    };
    timeline.push(welcome);

    var consent = {
      type: "html-button-response",
      choices: ["I agree"],
      stimulus: "<div style='word-wrap: break-word; width: 900px'><h3>Please consider this information carefully before deciding whether to participate in this research</h3>" +
        "<ul style='text-align: left; font-size: .8em;'><li><b>Purpose of the research</b>: To examine how people process images.</li>" +
        "<li><b>What you will do in this research</b>:  Stimuli (images) will be presented on the computer and you will be asked different questions about them.</li>" +
        "<li><b>Time required</b>: Participation will take between 10 and 20 minutes to complete.</li>" +
        "<li><b>Risks</b>:  There are no anticipated risks associated with participating in this study. The effects of participating should be comparable to those you would experience from viewing a computer monitor for 30 minutes and using a mouse or keyboard.</li>" +
        "<li><b>Benefits</b>:  This study provides no benefits to you individually except for the credit. The study provides important information about the nature of perception and learning.</li>" +
        "<li><b>Confidentiality</b>:  Your participation in this study will remain confidential. No personally identifiable information will be associated with your data. Your de-identified data may be shared with other researchers and used in future projects.</li>" +
        "<li><b>Participation and withdrawal</b>:  Your participation in this study is completely voluntary and you may refuse to participate or you may choose to withdraw at any time without penalty.</li>" +
        "<li><b>How to contact the researchers</b>: If you have questions or concerns about your participation or payment, or want to request a summary of research findings, please contact Sander Van de Cruys (University of Leuven), at sander.vandecruys@kuleuven.be.</li></ul>" +
        "<p>The nature and purpose of this research have been sufficiently explained and I agree to participate in this study.  I understand that I am free to withdraw at any time without incurring any penalty.</p>" +
        "<p>Please consent by clicking the button below to continue. Otherwise, please exit the study at this time.</p></div>",
      data: {
        test_part: 'instructions'
      }
    };
    timeline.push(consent);

    timeline.push({
      type: 'fullscreen',
      fullscreen_mode: true,
      data: {
        test_part: 'instructions'
      }
    });

    var chineseprior = {
      type: 'html-button-response',
      stimulus: '<p>Do you have any knowledge of chinese or japanese (written) language (hanzi, kanji, kana)?</p>',
      choices: ['Yes', 'No'],
      prompt: "",
      data: {
        test_part: 'chineseprior'
      }
    };
    timeline.push(chineseprior);

    var debrief = {
      type: 'html-button-response',
      stimulus: '<p>Would you like to be informed of the general goals and results of this study afterwards?</p>',
      choices: ['Yes', 'No'],
      prompt: "",
      data: {
        test_part: 'debrief'
      }
    };
    //timeline.push(debrief);



    /* define instructions trial */
    var instructions1 = {
      type: "html-keyboard-response",
      stimulus: "<div style='word-wrap: break-word; width: 900px'><h3>Instructions</h3><p>In this experiment you will have two tasks. You will see images like the one you can see on the left. These distorted images are derived from actual photographs as you can see on the right. First, you will <strong>briefly</strong> see the distorted image.</p> <div style='float: left; margin-right: 20px;'><img src='../img/018tt.jpg' height='250' width='250'></img></div><div style='float: right; margin-left: 20px;'><img src='../img/018gs.jpg' height='250' width='250'></img></div><p>Next, you will be asked to indicate whether or not you think you would be able to solve it (identify what's in the original photograph) if you would be allowed to view the image <strong>for as long as you wanted</strong>. Next you will briefly see the solution. After that, you will very briefly see a character from the Chinese alphabet. We are interested in <strong>how intuitive the meaning of those characters is</strong>. So you will have to indicate for each of these characters whether you think it represents <strong>something good/pleasant, or something bad/unpleasant</strong>. Try to go with your first, intuitive response. We realize these questions are difficult and require you to make a guess based on insufficient information, but there's no right or wrong answers. Just pay attention and make the guess that feels most right, you don't need to think about it too much. <p>Press any key to start a few practice trials.</p></div>",
      post_trial_gap: 0,
      data: {
        test_part: 'instructions'
      }
    };
    timeline.push(instructions1);


    /* phase 1 */

    var fixation = {
      type: 'html-keyboard-response',
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: jsPsych.NO_KEYS,
      trial_duration: 200,
      data: {
        test_part: 'fixation'
      }
    }

    var mooney1 = {
      type: 'image-keyboard-response',
      stimulus: jsPsych.timelineVariable('mooney'),
      orientation: function () {
        console.log(jsPsych.timelineVariable('condition', true))
        if (jsPsych.timelineVariable('condition', true) == 'NAHA') {
          return 180
        } else {
          return 0
        }
      },
      choices: jsPsych.NO_KEYS,
      trial_duration: 3000,
      data: {
        test_part: 'mooney1'
      }
    };


    solvability = {
      type: 'html-keyboard-response',
      stimulus: '<p>Do you think you would be able to solve this image when given unlimited viewing time? <br><br>Press the <strong>N</strong>-key if "rather no", press the <strong>Y</strong>-key if "rather yes".</p>',
      choices: ['y', 'n'],
      data: {
        test_part: 'solvability'
      },
      on_finish: function (data) {
        data.ahacond = jsPsych.timelineVariable('condition', true);
        data.currentStim = jsPsych.timelineVariable('mooney', true);
        if (data.key_press == 78) {
            data.solvability = 0;
            
          } else {
            data.solvability = 1;

          }
      }
    };


    var mooney2 = {
      type: 'image-keyboard-response',
      stimulus: jsPsych.timelineVariable('mooney'),
      orientation: function () {
        if (jsPsych.timelineVariable('condition', true) == 'NAHA') {
          return 180
        } else {
          return 0
        }
      },
      choices: jsPsych.NO_KEYS,
      trial_duration: 2500,
      data: {
        test_part: 'mooney2'
      }
    };

    var reveal = {
      type: 'image-keyboard-response',
      stimulus: jsPsych.timelineVariable('solution'),
      choices: jsPsych.NO_KEYS,
      trial_duration: 500,
      data: {
        test_part: 'reveal'
      }
    };

    var mooney3 = {
      type: 'image-keyboard-response',
      stimulus: jsPsych.timelineVariable('mooney'),
      orientation: function () {
        if (jsPsych.timelineVariable('condition', true) == 'NAHA') {
          return 180
        } else {
          return 0
        }
      },
      choices: jsPsych.NO_KEYS,
      trial_duration: 1500,
      data: {
        test_part: 'mooney3'
      }
    };

    isi = {
      type: 'html-keyboard-response',
      stimulus: '',
      choices: jsPsych.NO_KEYS,
      trial_duration: 200,
      data: {
        test_part: 'isi'
      },
    };

    var target = {
      type: 'image-keyboard-response',
      stimulus: jsPsych.timelineVariable('pict'),
      choices: ['leftarrow', 'rightarrow'],
      trial_duration: 500,
      data: {
        test_part: 'target'
      },
      on_finish: function (data) {
        data.ahacond = jsPsych.timelineVariable('condition', true);
        data.currentStim = jsPsych.timelineVariable('mooney', true);

        if (data.key_press == null) {
          data.pressed = 0;
        } else {
          data.pressed = 1;

        }
      }
    };

    affect = {
      type: 'html-keyboard-response',
      stimulus: '<p>Do you think this character expresses something bad/unpleasant or something good/pleasant?<br><br>Press <strong>left arrow</strong> for something bad or unpleasant<br>Press <strong>right arrow</strong> for something good or pleasant. </p>',
      choices: ['leftarrow', 'rightarrow'],
      trial_duration: function () {
        var already_responded = jsPsych.data.get().last(1).values()[0].pressed;
        if (already_responded) {
          return 0
        } else {
          return null
        }
      },
      data: {
        test_part: 'affect'
      },
      on_finish: function (data) {
        data.ahacond = jsPsych.timelineVariable('condition', true);
        data.currentStim = jsPsych.timelineVariable('mooney', true);

        var already_responded = jsPsych.data.get().last(1).values()[0].pressed;
        if (already_responded) {
          if (jsPsych.data.get().last(1).values()[0].key_press == 37) {
            data.affect = 0;
            data.rtfinal = jsPsych.data.get().last(1).values()[0].rt
          } else {
            data.affect = 1;
            data.rtfinal = data.rt+500

          }
        } else {
          if (data.key_press == 37) {
            data.affect = 0;
            data.rtfinal = data.rt+500
          } else {
            data.affect = 1;
            data.rtfinal = data.rt+500

          }
        }


      }
    };

    // attentioncheck = {
    //   type: 'html-keyboard-response',
    //   stimulus: '<p>Was there one or more animals (<strong>excluding humans</strong>) in the photograph or not? Press <strong>left arrow</strong> if yes, or <strong>right arrow</strong> if no.</p>',
    //   choices: ['leftarrow', 'rightarrow'],
    //   data: {
    //     test_part: 'attentioncheck'
    //   },
    //   on_finish: function (data) {
    //     data.ahacond = jsPsych.timelineVariable('condition', true);
    //     data.currentStim = jsPsych.timelineVariable('mooney', true);
    //     jsPsych.setProgressBar(jsPsych.data.get().last(1).select('trial_index').mean() / (9 + (nb_stim_per_session *
    //       4) + (stimlist.length * 7)));
    //   }
    // };


    var practice = {
      timeline: [fixation, mooney1, solvability, mooney2, reveal, mooney3, isi, target, affect],
      timeline_variables: practicelist,
      repetitions: 1,
      randomize_order: true
    };

    timeline.push(practice);

    /* define instructions trial */
    var instructions2 = {
      type: "html-keyboard-response",
      stimulus: "<div style='word-wrap: break-word; width: 900px'><h3>Instructions</h3><p>Ok, now you know what to do. Remember, we always want your first, intuitive response, don't think for too long. Keep the fingers of your left hand on the Y and N key, and those of your right hand on the left and right arrow key.</p></div>",
      post_trial_gap: 0,
      data: {
        test_part: 'instructions'
      }
    };
    timeline.push(instructions2);

    var phase1_procedure = {
      timeline: [fixation, mooney1, solvability, mooney2, reveal, mooney3, target, affect],
      timeline_variables: stimlist,
      repetitions: 1,
      randomize_order: true
    };

    //timeline.push(phase1_procedure);


    /* define debrief */

    var debrief = {
      type: "html-keyboard-response",
      trial_duration: 2000,
      stimulus: "<h1>Thanks a lot for your time!</h1><p>You finished the complete experiment. Wait for the next screen to close the window...</p>",
      data: {
        test_part: 'thanks'
      }
    };
    timeline.push(debrief);

    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      show_progress_bar: true,
      auto_update_progress_bar: false,
      preload_images: images,
      exclusions: {
        min_width: 800,
        min_height: 700
      },
      on_finish: function () {
        jsPsych.data.addProperties({
          totalTime: jsPsych.totalTime(),
          subject: subject_id,
          experiment_name: experiment_name
        });
        saveData("curimoon.csv", jsPsych.data.get().csv());
      }
    });
  }
</script>

</html>